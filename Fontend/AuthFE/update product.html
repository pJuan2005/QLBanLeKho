<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Update Product</title>
  <link rel="stylesheet" href="../Shared/css/create product.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">üõí RetailPro<br><span>Inventory & POS</span></div>
        <nav>
            <ul>
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">POS</a></li>
                <li class="active"><a href="#">Products</a></li>
                <li><a href="#">Categories</a></li>
                <li><a href="#">Customers</a></li>
                <li><a href="#">Suppliers</a></li>
                <li><a href="#">Purchase Orders</a></li>
                <li><a href="#">Stock Management</a></li>
                <li><a href="#">Sales & Returns</a></li>
                <li><a href="#">Payments & Debts</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Settings</a></li>
            </ul>
        </nav>
        <div class="user">
            <div class="avatar">J</div>
            <div class="info">
                <p>John Doe</p>
                <small>Admin</small>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div class="header-bar">
        <h1>Update Product</h1>
        <a href="product.html" class="btn-back">‚Üê Back to Products</a>
      </div>

      <section class="form-section">
        <h2><span>‚ÑπÔ∏è</span> Product Information</h2>

        <form id="UpdateProductForm" class="form-grid">
          <!-- Product Name -->
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="productName" required />
          </div>

          <!-- Category -->
          <div class="form-group">
            <label>Category *</label>
            <select id="category" required>
            </select>
          </div>

          <!-- SKU -->
          <div class="form-group">
            <label>SKU *</label>
            <div class="input-with-btn">
              <input type="text" id="sku" required />
              <button type="button" id="generateSku">Generate</button>
            </div>
          </div>

          <!-- Barcode -->
          <div class="form-group">
            <label>Barcode</label>
            <input type="text" id="barcode" />
          </div>

          <!-- Unit -->
          <div class="form-group">
            <label>Unit</label>
            <input type="text" id="unit" />
          </div>

          <!-- Quantity -->
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="quantity" min="0" value="0" />
          </div>

          <!-- Min Stock -->
          <div class="form-group">
            <label>Min Stock</label>
            <input type="number" id="minStock" min="0" value="0" />
          </div>

          <!-- VAT Rate -->
          <div class="form-group">
            <label>VAT Rate (%)</label>
            <input type="number" id="vatRate" min="0" step="0.01" placeholder="0.00" />
          </div>

          <!-- Status -->
          <div class="form-group">
            <label>Status</label>
            <select id="status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>

          <!-- Image -->
          <div class="form-group full">
            <label>Product Image</label>
            <input type="file" id="image" accept="image/*" />
          </div>

          <!-- Buttons -->
          <div class="form-actions full">
            <button type="submit" class="btn-primary">Save Product</button>
            <button type="button" id="refreshForm" class="btn-refresh">üîÑ Refresh</button>
          </div>
        </form>
      </section>
    </main>
  </div>
</body>


<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="../Shared/angular/global.js"></script>



<script>
// =====================================================
// üîó C·∫•u h√¨nh API
// =====================================================
const API_BASE = `${current_url}/api-core/product`;
const apiCategory = "http://localhost:5000/api-core/category/search";

// L·∫•y ProductID t·ª´ URL (?id=xxx)
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");

// Khai b√°o bi·∫øn to√†n c·ª•c
let categoryChoices = null;

// DOM Elements
const form = document.getElementById("UpdateProductForm");
const nameInput = document.getElementById("productName");
const categorySelect = document.getElementById("category");
const skuInput = document.getElementById("sku");
const barcodeInput = document.getElementById("barcode");
const unitInput = document.getElementById("unit");
const qtyInput = document.getElementById("quantity");
const minStockInput = document.getElementById("minStock");
const vatRateInput = document.getElementById("vatRate");
const statusSelect = document.getElementById("status");
const imageInput = document.getElementById("image");

// =====================================================
// üóÇÔ∏è Load danh s√°ch Category
// =====================================================
async function loadCategories() {
  try {
    const response = await fetch(apiCategory, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        page: 1,
        pageSize: 9999999,
        CategoryID: null,
        CategoryName: "",
        option: ""
      }),
    });

    if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c!");

    const result = await response.json();
    const categories = result.data || [];

    // X√≥a d·ªØ li·ªáu c≈©
    categorySelect.innerHTML = '<option value="">Select</option>';

    // G·∫Øn danh m·ª•c m·ªõi
    categories.forEach(c => {
      const option = document.createElement("option");
      option.value = String(c.categoryID);
      option.textContent = c.categoryName;
      categorySelect.appendChild(option);
    });

    // N·∫øu Choices.js ƒë√£ t·ªìn t·∫°i ‚Üí h·ªßy v√† t·∫°o l·∫°i
    if (categoryChoices) categoryChoices.destroy();

    categoryChoices = new Choices(categorySelect, {
      searchEnabled: true,
      itemSelectText: "",
      shouldSort: false,
      allowHTML: true
    });

    return true;
  } catch (error) {
    console.error("‚ùå L·ªói khi t·∫£i danh m·ª•c:", error);
    categorySelect.innerHTML = '<option value="">(Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu)</option>';
    if (categoryChoices) categoryChoices.destroy();
    return false;
  }
}

// =====================================================
// üîπ Load s·∫£n ph·∫©m theo ID
// =====================================================
async function loadProduct() {
  if (!productId) {
    alert("‚ùå Kh√¥ng t√¨m th·∫•y ProductID trong URL!");
    window.location.href = "product.html";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/get-by-id/${productId}`);
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m");

    const product = await res.json();

    // G√°n d·ªØ li·ªáu v√†o form
    nameInput.value = product.productName || "";
    skuInput.value = product.sku || "";
    barcodeInput.value = product.barcode || "";
    unitInput.value = product.unit || "";
    qtyInput.value = product.quantity ?? 0;
    minStockInput.value = product.minStock ?? 0;
    vatRateInput.value = product.vatRate ?? 0;
    statusSelect.value = product.status || "Active";

    // ‚úÖ Set Category trong Choices.js
    const catId = product.categoryID ? String(product.categoryID) : "";
    if (categoryChoices) {
      categoryChoices.setChoiceByValue(catId);
    } else {
      categorySelect.value = catId;
    }

    // ‚úÖ Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i
    const oldPreview = document.querySelector("#currentImagePreview");
    if (oldPreview) oldPreview.remove();

    if (product.image) {
      const imgPreview = document.createElement("img");
      imgPreview.id = "currentImagePreview";
      imgPreview.src = `${product.image}`;
      imgPreview.alt = "Current Product Image";
      imgPreview.style.maxWidth = "150px";
      imgPreview.style.borderRadius = "8px";
      imgPreview.style.marginTop = "8px";
      imageInput.insertAdjacentElement("afterend", imgPreview);
    }
  } catch (error) {
    console.error("‚ùå L·ªói load s·∫£n ph·∫©m:", error);
    alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m!");
  }
}

// =====================================================
// üîπ G·ª≠i form c·∫≠p nh·∫≠t s·∫£n ph·∫©m
// =====================================================
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("ProductID", productId);
  formData.append("ProductName", nameInput.value);
  formData.append("CategoryID", categorySelect.value);
  formData.append("SKU", skuInput.value);
  formData.append("Barcode", barcodeInput.value);
  formData.append("Unit", unitInput.value);
  formData.append("Quantity", qtyInput.value);
  formData.append("MinStock", minStockInput.value);
  formData.append("VATRate", vatRateInput.value);
  formData.append("Status", statusSelect.value);

  if (imageInput.files.length > 0) {
    formData.append("imageFile", imageInput.files[0]);
  }

  try {
    const response = await fetch(`${API_BASE}/update-product/${productId}`, {
      method: "PUT",
      body: formData,
    });

    const result = await response.json();

    if (response.ok) {
      alert("‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!");
      window.location.href = "product.html";
    } else {
      alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t: " + (result.message || "Kh√¥ng x√°c ƒë·ªãnh"));
    }
  } catch (error) {
    console.error("‚ùå Error:", error);
    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
  }
});

// =====================================================
// üîπ N√∫t Refresh
// =====================================================
document.getElementById("refreshForm").addEventListener("click", (e) => {
  e.preventDefault();
  loadProduct();
});

// =====================================================
// üîπ Generate SKU
// =====================================================
document.getElementById("generateSku").addEventListener("click", () => {
  const randomSKU = "SKU-" + Math.random().toString(36).substring(2, 8).toUpperCase();
  skuInput.value = randomSKU;
});

// =====================================================
// üîπ Khi trang load: load category tr∆∞·ªõc r·ªìi load product
// =====================================================
window.addEventListener("DOMContentLoaded", async () => {
  const ok = await loadCategories();
  if (ok) await loadProduct();
});
</script>

</html>
