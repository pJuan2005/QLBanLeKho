<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chi tiết đơn mua hàng</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- LOAD FILE GLOBAL TRƯỚC -->
  <script src="../Shared/angular/global.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .container {
      background: white; width: 100%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); overflow: hidden;
    }
    .header {
      padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
    }
    .header h3 { margin: 0; font-size: 18px; color: #333; }
    .close { font-size: 24px; cursor: pointer; color: #aaa; }
    .close:hover { color: #000; }
    .body { padding: 20px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      padding: 10px; text-align: left; border-bottom: 1px solid #eee;
    }
    th { background: #f8fafc; font-weight: 600; color: #444; }
    .empty { text-align: center; padding: 40px; color: #888; }
    .footer { padding: 16px 20px; border-top: 1px solid #eee; text-align: right; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-outline { background: #f1f1f1; color: #333; }
    .icon-btn {
    background: none; border: none; cursor: pointer; padding: 4px; font-size: 14px;
    }
    .icon-btn.delete { color: #dc3545; }
    .icon-btn.delete:hover { color: #c82333; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h3>Chi tiết đơn mua hàng <span id="poId"></span></h3>
      <span class="close">×</span>
    </div>
    <div class="body">
      <table id="detailsTable">
        <thead>
          <tr>
            <th>POID</th>
            <th>ProductID</th>
            <th>Tên sản phẩm</th>
            <th>Số lượng</th>
            <th>Đơn giá</th>
          </tr>
        </thead>
        <tbody id="detailsBody">
          <!-- Dữ liệu sẽ được đổ vào đây -->
        </tbody>
      </table>

      <div style="margin-top: 20px; padding: 16px; background: #f9f9f9; border-radius: 6px;">
        <h4 style="margin: 0 0 12px 0; color: #333;">Thêm chi tiết mới</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
          
          <!-- POID - KHÔNG CHO SỬA -->
          <div>
            <label style="display: block; font-size: 13px; color: #555; margin-bottom: 4px;">POID</label>
            <input type="text" id="inputPOID" readonly 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
          </div>

          <!-- ProductID -->
          <div>
            <label style="display: block; font-size: 13px; color: #555; margin-bottom: 4px;">ProductID</label>
            <input type="number" id="inputProductID" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <!-- Quantity -->
          <div>
            <label style="display: block; font-size: 13px; color: #555; margin-bottom: 4px;">Số lượng</label>
            <input type="number" id="inputQuantity" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <!-- UnitPrice -->
          <div>
            <label style="display: block; font-size: 13px; color: #555; margin-bottom: 4px;">Đơn giá</label>
            <input type="number" id="inputUnitPrice" min="0" step="0.01" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <!-- Nút Thêm -->
          <div style="display: flex; align-items: end;">
            <button id="btnAddDetail" 
                    style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Thêm
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <button class="btn btn-outline">Đóng</button>
    </div>
  </div>

  <script>
    // DỰA TRÊN current_url → QUA GATEWAY
const API_BASE = `${current_url}/api-core/purchaseorderdetails`;

    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const poid = urlParams.get('poid');

        const poIdSpan = document.getElementById("poId");
        const inputPOID = document.getElementById("inputPOID");

        if (poIdSpan) poIdSpan.textContent = `POID: ${poid}`;
        if (inputPOID) inputPOID.value = poid;

        loadDetails();
        setupCloseButtons();
        document.getElementById("btnAddDetail").onclick = addDetail;
    });

    async function loadDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const poid = urlParams.get('poid');
        const tbody = document.getElementById("detailsBody");
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Đang tải...</td></tr>";

        try {
            const response = await fetch(`${API_BASE}/get-by-poid/${poid}`);
            if (!response.ok) throw new Error("Không tải được dữ liệu");
            const details = await response.json();

            if (!details || details.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty">Không có chi tiết nào</td></tr>`;
                return;
            }

            tbody.innerHTML = details.map(d => `
                <tr data-poid="${d.poid}" data-productid="${d.productID}">
                    <td>${d.poid}</td>
                    <td>${d.productID}</td>
                    <td>${d.nameProduct || '—'}</td>
                    <td>${d.quantity}</td>
                    <td>$${parseFloat(d.unitPrice).toFixed(2)}</td>
                    <td>
                        <button class="icon-btn delete" title="Xóa" 
                                onclick="deleteDetail(${d.poid}, ${d.productID})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join("");

        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Lỗi: ${error.message}</td></tr>`;
        }
    }

    async function addDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const poid = urlParams.get('poid');
        const productId = document.getElementById("inputProductID").value.trim();
        const quantity = document.getElementById("inputQuantity").value.trim();
        const unitPrice = document.getElementById("inputUnitPrice").value.trim();

        if (!productId || !quantity || !unitPrice) {
            alert("Vui lòng nhập đầy đủ thông tin!");
            return;
        }

        const newDetail = {
            poid: parseInt(poid),
            productID: parseInt(productId),
            quantity: parseInt(quantity),
            unitPrice: parseFloat(unitPrice)
        };

        try {
            const response = await fetch(`${API_BASE}/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify([newDetail])
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(err || "Thêm thất bại");
            }

            // XÓA Ô NHẬP
            document.getElementById("inputProductID").value = "";
            document.getElementById("inputQuantity").value = "";
            document.getElementById("inputUnitPrice").value = "";

            loadDetails();

            if (window.opener && window.opener.refreshPOTable) {
                window.opener.refreshPOTable();
            }

        } catch (error) {
            alert("Lỗi: " + error.message);
        }
    }

    async function deleteDetail(poid, productId) {
      if (!confirm(`Xóa chi tiết POID=${poid}, ProductID=${productId}?`)) return;

     const deleteModel = { poid: poid, productID: productId };

      try {
          const response = await fetch(`${API_BASE}/delete`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(deleteModel)
          });

          if (!response.ok) {
              const err = await response.text();
              throw new Error(err || "Xóa thất bại");
          }

          alert("Xóa thành công!");
          loadDetails(); // Reload bảng chi tiết

          // Cập nhật bảng chính (nếu cần)
          if (window.opener && window.opener.refreshPOTable) {
              window.opener.refreshPOTable();
          }

        } catch (error) {
          alert("Lỗi: " + error.message);
      }
}

    function closePopup() {
        window.close();
    }

    function setupCloseButtons() {
        document.querySelector(".close").onclick = closePopup;
        document.querySelector(".btn-outline").onclick = closePopup;
    }
  </script>

</body>
</html>