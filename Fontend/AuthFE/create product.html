<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Product</title>
  <link rel="stylesheet" href="../Shared/css/create product.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">üõí RetailPro<br><span>Inventory & POS</span></div>
        <nav>
            <ul>
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">POS</a></li>
                <li class="active"><a href="#">Products</a></li>
                <li><a href="#">Categories</a></li>
                <li><a href="#">Customers</a></li>
                <li><a href="#">Suppliers</a></li>
                <li><a href="#">Purchase Orders</a></li>
                <li><a href="#">Stock Management</a></li>
                <li><a href="#">Sales & Returns</a></li>
                <li><a href="#">Payments & Debts</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Settings</a></li>
            </ul>
        </nav>
        <div class="user">
            <div class="avatar">J</div>
            <div class="info">
                <p>John Doe</p>
                <small>Admin</small>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div class="header-bar">
        <h1>Create Product</h1>
        <a href="product.html" class="btn-back">‚Üê Back to Products</a>
      </div>

      <section class="form-section">
        <h2><span>‚ÑπÔ∏è</span> Product Information</h2>

        <form id="createProductForm" class="form-grid">
          <!-- Product Name -->
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="productName" required />
          </div>

          <!-- Category -->
          <div class="form-group">
            <label>Category *</label>
            <select id="category" required>
            </select>
          </div>

          <!-- SKU -->
          <div class="form-group">
            <label>SKU *</label>
            <div class="input-with-btn">
              <input type="text" id="sku" required />
              <button type="button" id="generateSku">Generate</button>
            </div>
          </div>

          <!-- Barcode -->
          <div class="form-group">
            <label>Barcode</label>
            <input type="text" id="barcode" />
          </div>

          <!-- Unit -->
          <div class="form-group">
            <label>Unit</label>
            <input type="text" id="unit" />
          </div>

          <!-- Quantity -->
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="quantity" min="0" value="0" />
          </div>

          <!-- Min Stock -->
          <div class="form-group">
            <label>Min Stock</label>
            <input type="number" id="minStock" min="0" value="0" />
          </div>

          <!-- VAT Rate -->
          <div class="form-group">
            <label>VAT Rate (%)</label>
            <input type="number" id="vatRate" min="0" step="0.01" placeholder="0.00" />
          </div>

          <!-- Status -->
          <div class="form-group">
            <label>Status</label>
            <select id="status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>

          <!-- Image -->
          <div class="form-group full">
            <label>Product Image</label>
            <input type="file" id="image" accept="image/*" />
          </div>

          <!-- Buttons -->
          <div class="form-actions full">
            <button type="submit" class="btn-primary">Save Product</button>
            <button type="button" id="refreshForm" class="btn-refresh">üîÑ Refresh</button>
          </div>
        </form>
      </section>
    </main>
  </div>
</body>


<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>


<script>
// üîó API endpoints
const apiCreate = "https://localhost:7092/api/Product/create-product";
const apiSearch = "https://localhost:7092/api/Product/search-product";


// üß© H√†m t·∫°o SKU t·ª± ƒë·ªông
document.getElementById("generateSku").addEventListener("click", () => {
  const sku = "SKU-" + Math.floor(Math.random() * 1000000);
  document.getElementById("sku").value = sku;
});

// üîÅ L√†m m·ªõi form
document.getElementById("refreshForm").addEventListener("click", () => {
  document.getElementById("createProductForm").reset();
  alert("ƒê√£ l√†m m·ªõi form!");
});

// =====================================================
// üîç Ki·ªÉm tra tr√πng SKU & Barcode tr∆∞·ªõc khi th√™m s·∫£n ph·∫©m
// =====================================================
async function checkDuplicateSKUAndBarcode(sku, barcode) {
  try {
    // G·ª≠i song song 2 request ƒë·ªÉ ki·ªÉm tra tr√πng
    const [resSku, resBarcode] = await Promise.all([
      fetch(apiSearch, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          page: 1,
          pageSize: 0, // ‚úÖ l·∫•y to√†n b·ªô d·ªØ li·ªáu
          productID: null,
          SKU: sku,
          Barcode: "",
          ProductName: "",
          CategoryID: null,
          Status: ""
        }),
      }),
      fetch(apiSearch, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          page: 1,
          pageSize: 0, // ‚úÖ l·∫•y to√†n b·ªô d·ªØ li·ªáu
          productID: null,
          SKU: "",
          Barcode: barcode,
          ProductName: "",
          CategoryID: null,
          Status: ""
        }),
      }),
    ]);

    const [resultSku, resultBarcode] = await Promise.all([
      resSku.json(),
      resBarcode.json(),
    ]);

    // ‚úÖ Ki·ªÉm tra SKU tr√πng
    const duplicateSku = resultSku.data?.find(
      p => String(p.SKU ?? p.sku ?? "").trim().toLowerCase() === sku.toLowerCase()
    );

    // ‚úÖ Ki·ªÉm tra Barcode tr√πng
    const duplicateBarcode = resultBarcode.data?.find(
      p => String(p.Barcode ?? p.barcode ?? "").trim().toLowerCase() === barcode.toLowerCase()
    );

    return { duplicateSku, duplicateBarcode };
  } catch (error) {
    console.error("‚ùå L·ªói khi ki·ªÉm tra tr√πng SKU/Barcode:", error);
    return { duplicateSku: null, duplicateBarcode: null };
  }
}

// =====================================================
// üöÄ Khi nh·∫•n n√∫t "Save Product"
// =====================================================
document.getElementById("createProductForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // üßæ L·∫•y d·ªØ li·ªáu t·ª´ form
  const productName = document.getElementById("productName").value.trim();
  const categoryID = parseInt(document.getElementById("category").value);
  const sku = document.getElementById("sku").value.trim();
  const barcode = document.getElementById("barcode").value.trim();
  const unit = document.getElementById("unit").value;
  const quantity = parseInt(document.getElementById("quantity").value) || 0;
  const minStock = parseInt(document.getElementById("minStock").value) || 0;
  const vatRate = parseFloat(document.getElementById("vatRate").value) || 0;
  const status = document.getElementById("status").value;
  const imageFile = document.getElementById("image").files[0];

  // ‚ö†Ô∏è Ki·ªÉm tra b·∫Øt bu·ªôc
  if (!productName || !categoryID || !sku) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Product Name, Category v√† SKU!");
    return;
  }

  // üîç Ki·ªÉm tra tr√πng SKU & Barcode
  const { duplicateSku, duplicateBarcode } = await checkDuplicateSKUAndBarcode(sku, barcode);

  if (duplicateSku) {
    alert("‚ùå SKU n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
    return;
  }

  if (duplicateBarcode) {
    alert("‚ùå Barcode n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
    return;
  }

  // üì¶ T·∫°o FormData g·ª≠i l√™n API
  const formData = new FormData();
  formData.append("ProductName", productName);
  formData.append("CategoryID", categoryID);
  formData.append("SKU", sku);
  formData.append("Barcode", barcode);
  formData.append("Unit", unit);
  formData.append("Quantity", quantity);
  formData.append("MinStock", minStock);
  formData.append("VATRate", vatRate);
  formData.append("Status", status);
  if (imageFile) formData.append("imageFile", imageFile);

  // üöÄ G·ª≠i API t·∫°o s·∫£n ph·∫©m
  try {
    const createResponse = await fetch(apiCreate, {
      method: "POST",
      body: formData,
    });

    if (createResponse.ok) {
      alert("‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");
      window.location.href = "product.html"; // Quay l·∫°i danh s√°ch
    } else {
      const errorText = await createResponse.text();
      alert("‚ùå L·ªói khi th√™m s·∫£n ph·∫©m: " + errorText);
    }
  } catch (error) {
    alert("‚ö†Ô∏è L·ªói khi g·ª≠i y√™u c·∫ßu: " + error.message);
  }
});




// =====================================================
// üóÇÔ∏è Load danh s√°ch Category t·ª´ SQL qua API
// =====================================================
async function loadCategories() {
  const apiCategory = "https://localhost:7092/api/category/search";
  const select = document.getElementById("category");

  try {
    // G·ªçi API l·∫•y to√†n b·ªô danh m·ª•c (pageSize = 0 ƒë·ªÉ l·∫•y h·∫øt)
    const response = await fetch(apiCategory, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        page: 1,
        pageSize: 9999999,         // ‚úÖ l·∫•y t·∫•t c·∫£ danh m·ª•c
        CategoryID: null,
        CategoryName: "",
        option: ""
      }),
    });

    if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c!");

    const result = await response.json();
    const categories = result.data;

    // L√†m s·∫°ch dropdown
    select.innerHTML = '<option value="">Select</option>';

    // ƒê·ªï danh s√°ch danh m·ª•c v√†o dropdown
    categories.forEach(c => {
      const option = document.createElement("option");
      option.value = c.categoryID;        // ‚úÖ backend tr·∫£ "CategoryID"
      option.textContent = c.categoryName; // ‚úÖ backend tr·∫£ "CategoryName"
      select.appendChild(option);
    });


    new Choices(select, {
        searchEnabled: true,
        itemSelectText: "",
        shouldSort: false,
        allowHTML: true
    });



  } catch (error) {
    console.error("‚ùå L·ªói khi t·∫£i danh m·ª•c:", error);
    select.innerHTML = '<option value="">(Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu)</option>';
  }
}

// G·ªçi h√†m khi trang load xong
window.addEventListener("DOMContentLoaded", loadCategories);

</script>
</html>
